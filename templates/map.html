<!DOCTYPE html>
  <head>
    <meta charset=utf-8 />
<title>Multi-Stop Transit Routing</title>
    <link href='http://api.tiles.mapbox.com/mapbox.js/v1.2.0/mapbox.css' rel='stylesheet' />
    <!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script> -->
    <script src="jquery-1.11.1.min.js"></script>
    <script src="polyline.js"></script>
    <script src='http://api.tiles.mapbox.com/mapbox.js/v1.2.0/mapbox.js'></script>
    <style>
      #map { position:absolute; top:0; bottom:0; left:0; width:100%; }
    </style>
  </head>
  
  <body>

    <style>
      pre.pointA-coordinates {
        position:absolute;
        bottom:20px;
        left:30px;
        padding:5px 10px;
        background:rgba(0,0,0,0.5);
        color:#fff;
        font-size:13px;
        line-height:18px;
        border-radius:3px;
        }
      pre.pointB-coordinates2 {
        position:absolute;
        bottom:20px;
        left:300px;
        padding:5px 10px;
        background:rgba(0,0,0,0.5);
        color:#fff;
        font-size:13px;
        line-height:18px;
        border-radius:3px;
        }

        .ui-button {
          background:#3887BE;
          color:#FFF;
          display:block;
          position:absolute;
          top:20%;left:15%;
          width:130px;
          margin:-20px 0 0 -80px;
          z-index:100;
          text-align:center;
          padding:10px;
          border:0px solid rgba(0,0,0,0.4);
          border-radius:3px;
          }
        
        .ui-button:hover {
          background:#3074a4;
          color:#fff;
          }
    </style>

    <div id='map'></div>
    <a class='ui-button'>Find route</a>
    <pre id='coordinates' class='pointA-coordinates'></pre>
    <pre id='coordinates2' class='pointB-coordinates2'></pre>



    
    <script type='text/javascript'>


      
      var map = L.mapbox.map('map', 'meghan.ipb4b059', {
        gridLayer: {},
        gridControl: {
        sanitizer: function(x) { console.log(x); return x; }
        }
        })
        .setView([45.52282, -122.6766], 13);

      var pathLayer = new L.LayerGroup().addTo(map);
        
      var marker = L.marker(new L.LatLng(45.52282, -122.6766), {
        icon: L.mapbox.marker.icon({'marker-color': 'CC0033'}),
        draggable: true
        }).addTo(map);

      var marker2 = L.marker(new L.LatLng(45.52282, -122.69), {
        icon: L.mapbox.marker.icon({'marker-color': 'CC0033'}),
        draggable: true
        }).addTo(map);

    
      markerLocation();

      markerLocation2();

    
      marker.on('dragend', markerLocation);

      marker2.on('dragend', markerLocation2); 

      function markerLocation() {
          var pointA = marker.getLatLng();
          coordinates.innerHTML = 'POINT A <br>Latitude: ' + pointA.lat + '<br />Longitude: ' + pointA.lng;
          // console.log("lat: "+m.lat+" and lon: "+m.lng)
          // console.log("http:localhost:8080/otp/routers/default/plan?fromPlace="+m.lat+"%2C"+m.lng+"&toPlace=")
      };

      function markerLocation2() {
          var pointB = marker2.getLatLng();
          coordinates2.innerHTML = 'POINT B <br>Latitude: ' + pointB.lat + '<br />Longitude: ' + pointB.lng;
          // console.log(l.lat, l.lng)
      };      // };

      function generate_url () {
        var pointA = marker.getLatLng();
        var pointB = marker2.getLatLng();
        url = "http:localhost:8080/otp/routers/default/plan?fromPlace="+pointA.lat+"%2C"+pointA.lng+"&toPlace="+pointB.lat+"%2C"+pointB.lng+"&time=3%3A20pm&date=07-16-2014&mode=TRANSIT%2CWALK&maxWalkDistance=750&arriveBy=false&showIntermediateStops=false"
        return url
      };
      
       

      function get_routes () {
        pathLayer.clearLayers();
        var url = generate_url();      
        $.getJSON(url, function(data) {
          console.log("get_routes worked");
          $.each(data, function(index, element) {
            $('body').append($('<div>', {
              text: element.name
            }));
          })
          draw_routes(data);
        })
      }

      $(document).ready(function () {
        $(".ui-button").click(get_routes);
        });

      function draw_routes (data) {

        console.log(data);

        var legs = data.plan.itineraries[0].legs

        for(var i=0; i < legs.length; i++) {
          var leg = legs[i];
          // draw the polyline
          var route_line = new L.Polyline(polyline.decode(leg.legGeometry.points)).addTo(pathLayer);
          route_line.leg = leg;
          route_line.bindPopup("("+leg.routeShortName+") "+leg.routeLongName);
        }

        // returns an array of lat, lon pairs:
        // var line_points = polyline.decode('_p~iF~ps|U_ulLnnqC_mqNvxq`@');
        // console.log(line_points)
        // console.log("line_points ran")
        // var polyline_options = {
        //   color: '#000'
        //   };
        // var polyline = L.polyline(line_points, polyline_options).addTo(map);

      }

      </script>
        




      // // function map_route (path_data) {
      // //   // js function that uses path_data json to render route polyline


      // } 

      // }
      
    
    
  </body>
</html>